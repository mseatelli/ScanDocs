<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2575fc">
    <title>Scanner de Documents - D√©tection R√©elle OpenCV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- OpenCV.js - Version all√©g√©e pour mobile -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            min-height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(90deg, #2575fc, #6a11cb);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .app-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .camera-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background-color: #000;
            aspect-ratio: 4/3;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        #canvas {
            display: none;
        }
        
        #processing-canvas {
            display: none;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .document-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 2px dashed rgba(255,255,255,0.7);
            border-radius: 8px;
        }
        
        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f0f0f0;
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .camera-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 20px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(90deg, #2575fc, #6a11cb);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(37, 117, 252, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 140px;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        
        .capture-btn {
            background: linear-gradient(90deg, #ff5e7d, #ff9500);
            box-shadow: 0 4px 8px rgba(255, 94, 125, 0.3);
            flex: 2;
            padding: 18px;
            font-size: 1.2rem;
            min-height: 60px;
        }
        
        .detect-btn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            box-shadow: 0 4px 8px rgba(0, 176, 155, 0.3);
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }
        
        .upload-btn {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
        }
        
        .scans-section {
            margin-top: 20px;
            flex: 1;
        }
        
        h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #2575fc;
            text-align: center;
        }
        
        .scans-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .scan-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            position: relative;
        }
        
        .scan-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .scan-actions {
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .action-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: auto;
            flex: 1;
            margin: 0 2px;
        }
        
        .download-btn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
        }
        
        .delete-btn {
            background: linear-gradient(90deg, #ff5e7d, #ff2a6d);
        }
        
        .instructions {
            background: #f0f5ff;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .troubleshooting {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
        }
        
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d1edff;
            color: #0c5460;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-scans {
            text-align: center;
            padding: 30px 15px;
            color: #6c757d;
            font-style: italic;
            grid-column: 1 / -1;
        }
        
        .edge-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }
        
        .document-outline {
            position: absolute;
            border: 3px solid #00ff88;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
            transition: all 0.5s ease;
        }

        .quality-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            background: #2575fc;
        }
        
        .quality-badge.enhanced {
            background: #00b09b;
        }

        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 10;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .opencv-status {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>üì∏</span>
                Scanner OpenCV
            </h1>
            <p class="subtitle">D√©tection automatique des contours avec IA</p>
        </header>
        
        <div class="app-content">
            <div id="opencv-status" class="opencv-status">
                ‚è≥ Chargement d'OpenCV.js (8MB)...
            </div>
            
            <div class="camera-section">
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <canvas id="processing-canvas"></canvas>
                    <div class="processing-overlay" id="processing-overlay">
                        <div class="spinner"></div>
                        <div>Analyse IA en cours...</div>
                    </div>
                    <div class="camera-overlay">
                        <div class="document-guide"></div>
                        <div class="edge-preview" id="edge-preview">
                            <div class="document-outline" id="document-outline"></div>
                        </div>
                    </div>
                    <div class="camera-placeholder" id="camera-placeholder">
                        <div>üì∑</div>
                        <p>OpenCV.js en cours de chargement</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="start-camera" disabled>
                        <span>üì∑</span> Activer
                    </button>
                    <button id="capture" class="capture-btn" disabled>
                        <span>‚≠ï</span> Capturer
                    </button>
                    <button id="detect-edges" class="detect-btn" disabled>
                        <span>ü§ñ</span> D√©tection IA
                    </button>
                    <button id="save-pdf" disabled>
                        <span>üíæ</span> PDF
                    </button>
                </div>
                
                <div class="upload-section">
                    <button id="upload-btn" disabled>
                        <span>üìÅ</span> Importer une image
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>
                
                <div id="status" class="status"></div>
                
                <div class="troubleshooting">
                    <h4>üí° Conseil pour la d√©tection IA</h4>
                    <ul style="margin-left: 15px; margin-top: 5px;">
                        <li>Placez le document sur un fond contrast√©</li>
                        <li>√âvitez les reflets et ombres</li>
                        <li>Maintenez le t√©l√©phone bien droit</li>
                        <li>La d√©tection est plus pr√©cise avec de bons contrastes</li>
                    </ul>
                </div>
            </div>
            
            <div class="scans-section">
                <h2>Documents Scann√©s</h2>
                <div id="scans-container" class="scans-container">
                    <div class="no-scans">Aucun document scann√©</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let cv = null;
        let stream = null;
        let capturedImage = null;
        let scans = JSON.parse(localStorage.getItem('documentScans')) || [];
        let isOpenCvReady = false;

        // √âl√©ments DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const processingCanvas = document.getElementById('processing-canvas');
        const ctx = canvas.getContext('2d');
        const processingCtx = processingCanvas.getContext('2d');
        const startCameraButton = document.getElementById('start-camera');
        const captureButton = document.getElementById('capture');
        const detectEdgesButton = document.getElementById('detect-edges');
        const savePdfButton = document.getElementById('save-pdf');
        const statusDiv = document.getElementById('status');
        const scansContainer = document.getElementById('scans-container');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-btn');
        const edgePreview = document.getElementById('edge-preview');
        const documentOutline = document.getElementById('document-outline');
        const processingOverlay = document.getElementById('processing-overlay');
        const opencvStatus = document.getElementById('opencv-status');

        // OpenCV est pr√™t
        function onOpenCvReady() {
            cv = window.cv;
            isOpenCvReady = true;
            
            opencvStatus.innerHTML = '‚úÖ OpenCV.js charg√© !';
            opencvStatus.style.background = '#d1edff';
            
            startCameraButton.disabled = false;
            uploadButton.disabled = false;
            cameraPlaceholder.innerHTML = '<div>üì∑</div><p>Appuyez sur "Activer la cam√©ra"</p>';
            
            showStatus("OpenCV pr√™t - D√©tection IA activ√©e", "success");
            console.log('OpenCV version:', cv.version);
        }

        // VRAIE D√âTECTION DES CONTOURS AVEC OPENCV
        function detectDocumentWithOpenCV() {
            if (!capturedImage || !cv) return null;
            
            processingOverlay.style.display = 'flex';
            showStatus("üîç Analyse IA des contours...", "loading");
            
            // Utiliser setTimeout pour laisser l'interface se mettre √† jour
            setTimeout(() => {
                try {
                    const img = new Image();
                    img.onload = function() {
                        // Pr√©parer les canvas
                        canvas.width = img.width;
                        canvas.height = img.height;
                        processingCanvas.width = img.width;
                        processingCanvas.height = img.height;
                        
                        ctx.drawImage(img, 0, 0);
                        processingCtx.drawImage(img, 0, 0);
                        
                        // Convertir en matrice OpenCV
                        let src = cv.imread(processingCanvas);
                        
                        // 1. Conversion en niveaux de gris
                        let gray = new cv.Mat();
                        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                        
                        // 2. Flou gaussien pour r√©duire le bruit
                        let blurred = new cv.Mat();
                        cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                        
                        // 3. D√©tection des bords avec Canny
                        let edges = new cv.Mat();
                        cv.Canny(blurred, edges, 50, 150);
                        
                        // 4. Trouver les contours
                        let contours = new cv.MatVector();
                        let hierarchy = new cv.Mat();
                        cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                        
                        // 5. Trouver le plus grand contour rectangulaire
                        let largestContour = null;
                        let maxArea = 0;
                        
                        for (let i = 0; i < contours.size(); ++i) {
                            let contour = contours.get(i);
                            let area = cv.contourArea(contour);
                            
                            // Approximation du contour
                            let epsilon = 0.02 * cv.arcLength(contour, true);
                            let approx = new cv.Mat();
                            cv.approxPolyDP(contour, approx, epsilon, true);
                            
                            // V√©rifier si c'est un quadrilat√®re
                            if (area > maxArea && approx.rows == 4) {
                                maxArea = area;
                                largestContour = approx;
                            } else {
                                approx.delete();
                            }
                            contour.delete();
                        }
                        
                        if (largestContour && maxArea > (img.width * img.height * 0.1)) {
                            // Convertir les points du contour
                            let points = [];
                            for (let i = 0; i < 4; i++) {
                                let point = largestContour.data32S.slice(i * 2, i * 2 + 2);
                                points.push({ x: point[0], y: point[1] });
                            }
                            
                            // Trier les points dans l'ordre: haut-gauche, haut-droit, bas-droit, bas-gauche
                            points.sort((a, b) => a.y - b.y);
                            
                            let topPoints = points.slice(0, 2).sort((a, b) => a.x - b.x);
                            let bottomPoints = points.slice(2, 4).sort((a, b) => a.x - b.x);
                            
                            const sortedPoints = [
                                topPoints[0], // haut-gauche
                                topPoints[1], // haut-droit
                                bottomPoints[1], // bas-droit
                                bottomPoints[0]  // bas-gauche
                            ];
                            
                            // Afficher le r√©sultat
                            showDetectedDocument(sortedPoints);
                            applyPerspectiveCorrection(sortedPoints);
                            
                            showStatus("‚úÖ Document d√©tect√© avec pr√©cision !", "success");
                        } else {
                            showStatus("‚ùå Aucun document d√©tect√©", "error");
                        }
                        
                        // Nettoyer la m√©moire
                        src.delete(); gray.delete(); blurred.delete(); 
                        edges.delete(); contours.delete(); hierarchy.delete();
                        if (largestContour) largestContour.delete();
                        
                        processingOverlay.style.display = 'none';
                    };
                    
                    img.src = capturedImage;
                    
                } catch (error) {
                    console.error('Erreur OpenCV:', error);
                    showStatus("‚ùå Erreur lors de l'analyse", "error");
                    processingOverlay.style.display = 'none';
                }
            }, 100);
        }

        function showDetectedDocument(points) {
            const container = document.querySelector('.camera-container');
            const containerRect = container.getBoundingClientRect();
            
            // Calculer le rectangle englobant
            const minX = Math.min(...points.map(p => p.x));
            const minY = Math.min(...points.map(p => p.y));
            const maxX = Math.max(...points.map(p => p.x));
            const maxY = Math.max(...points.map(p => p.y));
            
            const scaleX = containerRect.width / canvas.width;
            const scaleY = containerRect.height / canvas.height;
            
            documentOutline.style.left = (minX * scaleX) + 'px';
            documentOutline.style.top = (minY * scaleY) + 'px';
            documentOutline.style.width = ((maxX - minX) * scaleX) + 'px';
            documentOutline.style.height = ((maxY - minY) * scaleY) + 'px';
            
            edgePreview.style.display = 'block';
            
            // Animation
            documentOutline.style.transform = 'scale(0.9)';
            documentOutline.style.opacity = '0';
            
            setTimeout(() => {
                documentOutline.style.transition = 'all 0.4s ease';
                documentOutline.style.transform = 'scale(1)';
                documentOutline.style.opacity = '1';
            }, 100);
        }

        function applyPerspectiveCorrection(points) {
            // Ici on pourrait appliquer une correction de perspective
            // pour redresser le document, mais c'est plus complexe
            console.log("Points du document d√©tect√©:", points);
        }

        // Gestion des √©v√©nements
        document.addEventListener('DOMContentLoaded', function() {
            updateScansDisplay();
            setupEventListeners();
        });

        function setupEventListeners() {
            startCameraButton.addEventListener('click', startCamera);
            captureButton.addEventListener('click', captureImage);
            detectEdgesButton.addEventListener('click', detectDocumentWithOpenCV);
            savePdfButton.addEventListener('click', saveAsPDF);
            uploadButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
        }

        async function startCamera() {
            try {
                showStatus("Activation de la cam√©ra...", "loading");
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                cameraPlaceholder.style.display = 'none';
                
                showStatus("‚úÖ Cam√©ra activ√©e", "success");
                startCameraButton.disabled = true;
                captureButton.disabled = false;
                
            } catch (error) {
                showStatus("‚ùå Erreur cam√©ra: " + error.message, "error");
            }
        }

        function captureImage() {
            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                capturedImage = canvas.toDataURL('image/jpeg', 0.9);
                
                showStatus("‚úÖ Image captur√©e", "success");
                detectEdgesButton.disabled = false;
                savePdfButton.disabled = false;
                edgePreview.style.display = 'none';
                
            } catch (error) {
                showStatus("‚ùå Erreur capture", "error");
            }
        }

        function saveAsPDF() {
            if (!capturedImage) return;
            
            showStatus("üìÑ G√©n√©ration du PDF...", "loading");
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const imgProps = pdf.getImageProperties(capturedImage);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(capturedImage, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `document-${timestamp}.pdf`;
            
            pdf.save(filename);
            
            const scan = {
                id: Date.now(),
                image: capturedImage,
                filename: filename,
                date: new Date().toLocaleString('fr-FR')
            };
            
            scans.unshift(scan);
            localStorage.setItem('documentScans', JSON.stringify(scans));
            
            showStatus("‚úÖ PDF g√©n√©r√©", "success");
            updateScansDisplay();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                capturedImage = e.target.result;
                showStatus("‚úÖ Image import√©e", "success");
                detectEdgesButton.disabled = false;
                savePdfButton.disabled = false;
                edgePreview.style.display = 'none';
                
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = capturedImage;
            };
            reader.readAsDataURL(file);
        }

        function updateScansDisplay() {
            if (scans.length === 0) {
                scansContainer.innerHTML = '<div class="no-scans">Aucun document scann√©</div>';
                return;
            }
            
            scansContainer.innerHTML = scans.map(scan => `
                <div class="scan-item">
                    <img src="${scan.image}" alt="Document scann√©" class="scan-preview">
                    <div class="scan-actions">
                        <button class="action-btn download-btn" onclick="downloadScan(${scan.id})">
                            <span>‚¨áÔ∏è</span>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteScan(${scan.id})">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                    <div style="padding: 8px; font-size: 0.7rem; color: #666; text-align: center;">
                        ${scan.date.split(' ')[0]}
                    </div>
                </div>
            `).join('');
        }

        function downloadScan(id) {
            const scan = scans.find(s => s.id === id);
            if (!scan) return;
            
            const link = document.createElement('a');
            link.href = scan.image;
            link.download = scan.filename.replace('.pdf', '.jpg');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function deleteScan(id) {
            if (confirm("Supprimer ce document ?")) {
                scans = scans.filter(s => s.id !== id);
                localStorage.setItem('documentScans', JSON.stringify(scans));
                updateScansDisplay();
                showStatus("Document supprim√©", "success");
            }
        }

        function showStatus(message, type = '') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
    </script>
</body>
</html>