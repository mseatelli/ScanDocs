<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2575fc">
    <title>Scanner de Documents - Application Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            min-height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(90deg, #2575fc, #6a11cb);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .app-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .camera-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background-color: #000;
            aspect-ratio: 4/3;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        #canvas {
            display: none;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .document-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 2px dashed rgba(255,255,255,0.7);
            border-radius: 8px;
        }
        
        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f0f0f0;
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .camera-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 20px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(90deg, #2575fc, #6a11cb);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(37, 117, 252, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 140px;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(37, 117, 252, 0.3);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .capture-btn {
            background: linear-gradient(90deg, #ff5e7d, #ff9500);
            box-shadow: 0 4px 8px rgba(255, 94, 125, 0.3);
            flex: 2;
            padding: 16px;
            font-size: 1.1rem;
        }
        
        .detect-btn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            box-shadow: 0 4px 8px rgba(0, 176, 155, 0.3);
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }
        
        .upload-btn {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
        }
        
        .scans-section {
            margin-top: 20px;
            flex: 1;
        }
        
        h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #2575fc;
            text-align: center;
        }
        
        .scans-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .scan-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            position: relative;
        }
        
        .scan-item:active {
            transform: scale(0.95);
        }
        
        .scan-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .scan-actions {
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .action-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
            min-width: auto;
            flex: 1;
            margin: 0 2px;
        }
        
        .download-btn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
        }
        
        .delete-btn {
            background: linear-gradient(90deg, #ff5e7d, #ff2a6d);
        }
        
        .instructions {
            background: #f0f5ff;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .instructions h3 {
            color: #2575fc;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .troubleshooting {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
        }
        
        .troubleshooting h4 {
            color: #856404;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d1edff;
            color: #0c5460;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-scans {
            text-align: center;
            padding: 30px 15px;
            color: #6c757d;
            font-style: italic;
            grid-column: 1 / -1;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .flash-btn, .switch-camera {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .edge-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }
        
        .document-outline {
            position: absolute;
            border: 3px solid #00ff88;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
            transition: all 0.5s ease;
        }
        
        .edge-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #00ff88;
            background: rgba(0, 255, 136, 0.3);
        }

        .quality-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            background: #2575fc;
        }
        
        .quality-badge.enhanced {
            background: #00b09b;
        }

        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 10;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mode paysage */
        @media (min-width: 768px) and (orientation: landscape) {
            .app-content {
                flex-direction: row;
                gap: 20px;
            }
            
            .camera-section {
                flex: 1;
            }
            
            .scans-section {
                flex: 1;
                margin-top: 0;
            }
            
            .scans-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* Grands √©crans */
        @media (min-width: 992px) {
            .container {
                max-width: 900px;
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>üì∏</span>
                Scanner de Documents
            </h1>
            <p class="subtitle">Capturez et convertissez vos documents en PDF</p>
        </header>
        
        <div class="app-content">
            <div class="camera-section">
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="processing-overlay" id="processing-overlay">
                        <div class="spinner"></div>
                        <div>D√©tection des contours en cours...</div>
                    </div>
                    <div class="camera-overlay">
                        <div class="document-guide"></div>
                        <div class="edge-preview" id="edge-preview">
                            <div class="document-outline" id="document-outline"></div>
                        </div>
                    </div>
                    <div class="camera-placeholder" id="camera-placeholder">
                        <i>üì∑</i>
                        <p>Appuyez sur "Activer la cam√©ra"</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="start-camera" class="start-btn">
                        <span>üì∑</span> Activer
                    </button>
                    <button id="capture" class="capture-btn" disabled>
                        <span>‚≠ï</span> Capturer
                    </button>
                    <button id="detect-edges" class="detect-btn" disabled>
                        <span>üîç</span> D√©tecter
                    </button>
                    <button id="save-pdf" disabled>
                        <span>üíæ</span> PDF
                    </button>
                </div>
                
                <div class="camera-controls">
                    <button class="flash-btn" id="flash-btn" disabled>‚ö°</button>
                    <button class="switch-camera" id="switch-camera" disabled>üîÑ</button>
                </div>
                
                <div class="upload-section">
                    <button id="upload-btn" class="upload-btn">
                        <span>üìÅ</span> Importer une image
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>
                
                <div id="status" class="status"></div>
                
                <div class="troubleshooting">
                    <h4><span>üí°</span> Conseils d'utilisation</h4>
                    <ul style="margin-left: 15px; margin-top: 5px;">
                        <li>Placez le document sur un fond contrast√©</li>
                        <li>Assurez-vous d'un bon √©clairage</li>
                        <li>Maintenez le t√©l√©phone parall√®le au document</li>
                        <li>Utilisez "D√©tecter" pour un cadrage automatique</li>
                    </ul>
                </div>
            </div>
            
            <div class="scans-section">
                <h2>Mes Documents Scann√©s</h2>
                <div id="scans-container" class="scans-container">
                    <div class="no-scans">Aucun document scann√© pour le moment</div>
                </div>
                
                <div class="instructions">
                    <h3><span>‚ÑπÔ∏è</span> Comment utiliser</h3>
                    <ol>
                        <li><strong>Activer la cam√©ra</strong> - Autorisez l'acc√®s quand demand√©</li>
                        <li><strong>Capturer</strong> - Prenez une photo du document</li>
                        <li><strong>D√©tecter</strong> - Cadrage automatique des contours</li>
                        <li><strong>G√©n√©rer PDF</strong> - T√©l√©chargez le fichier final</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // R√©f√©rences aux √©l√©ments DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraButton = document.getElementById('start-camera');
        const captureButton = document.getElementById('capture');
        const detectEdgesButton = document.getElementById('detect-edges');
        const savePdfButton = document.getElementById('save-pdf');
        const statusDiv = document.getElementById('status');
        const scansContainer = document.getElementById('scans-container');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-btn');
        const flashButton = document.getElementById('flash-btn');
        const switchCameraButton = document.getElementById('switch-camera');
        const edgePreview = document.getElementById('edge-preview');
        const documentOutline = document.getElementById('document-outline');
        const processingOverlay = document.getElementById('processing-overlay');
        
        // Variables globales
        let stream = null;
        let capturedImage = null;
        let scans = JSON.parse(localStorage.getItem('documentScans')) || [];
        let currentFacingMode = 'environment';
        let flashOn = false;
        let edgesDetected = false;
        let isProcessing = false;

        // Am√©lioration de la r√©activit√© des boutons
        function setupButtonListeners() {
            const buttons = [startCameraButton, captureButton, detectEdgesButton, savePdfButton, uploadButton];
            
            buttons.forEach(button => {
                if (button) {
                    // √âv√©nements pour mobile
                    button.addEventListener('touchstart', function(e) {
                        if (!this.disabled) {
                            this.style.transform = 'scale(0.95)';
                            this.style.opacity = '0.8';
                        }
                        e.preventDefault();
                    }, { passive: false });
                    
                    button.addEventListener('touchend', function(e) {
                        if (!this.disabled) {
                            this.style.transform = '';
                            this.style.opacity = '';
                        }
                        e.preventDefault();
                    }, { passive: false });
                    
                    button.addEventListener('click', function(e) {
                        if (!this.disabled) {
                            // Feedback haptique
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                            }
                        }
                    });
                }
            });
        }

        // V√©rifier le protocole
        function checkProtocol() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showStatus("‚ö†Ô∏è Pour la cam√©ra, cette application n√©cessite une connexion HTTPS", "error");
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            checkProtocol();
            updateScansDisplay();
            checkMobileFeatures();
            setupButtonListeners();
            
            edgePreview.style.display = 'none';
            
            // Essayer de d√©marrer automatiquement sur HTTPS
            if (location.protocol === 'https:') {
                setTimeout(() => {
                    startCamera();
                }, 1000);
            }
        });
        
        function checkMobileFeatures() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus("Votre navigateur ne supporte pas la cam√©ra", "error");
                startCameraButton.disabled = true;
                return;
            }
        }
        
        // D√©marrer la cam√©ra
        async function startCamera() {
            try {
                showStatus("Activation de la cam√©ra...", "loading");
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = stream;
                video.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                
                showStatus("‚úÖ Cam√©ra activ√©e - Cadrez votre document", "success");
                startCameraButton.disabled = true;
                captureButton.disabled = false;
                switchCameraButton.disabled = false;
                
            } catch (error) {
                console.error("Erreur cam√©ra:", error);
                handleCameraError(error);
            }
        }
        
        function handleCameraError(error) {
            let errorMessage = "";
            
            if (error.name === 'NotAllowedError') {
                errorMessage = "üìµ Permission refus√©e. Autorisez la cam√©ra dans les param√®tres de votre navigateur.";
            } else if (error.name === 'NotFoundError') {
                errorMessage = "üì∑ Aucune cam√©ra d√©tect√©e sur cet appareil";
            } else if (error.name === 'NotSupportedError') {
                errorMessage = "üö´ Votre navigateur ne supporte pas cette fonctionnalit√©";
            } else if (error.name === 'OverconstrainedError') {
                currentFacingMode = 'user';
                startCamera();
                return;
            } else {
                errorMessage = "Erreur d'acc√®s √† la cam√©ra: " + error.message;
            }
            
            showStatus(errorMessage, "error");
            startCameraButton.disabled = false;
            startCameraButton.textContent = "üîÑ R√©essayer";
        }
        
        // Capturer une image
        function captureImage() {
            if (isProcessing) return;
            
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedImage = canvas.toDataURL('image/jpeg', 0.8);
            
            showStatus("‚úÖ Document captur√© - Vous pouvez d√©tecter les contours", "success");
            detectEdgesButton.disabled = false;
            savePdfButton.disabled = false;
            edgesDetected = false;
            edgePreview.style.display = 'none';
            
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }
        
        // D√©tection des contours am√©lior√©e
        function detectEdges() {
            if (!capturedImage || isProcessing) return;
            
            isProcessing = true;
            processingOverlay.style.display = 'flex';
            showStatus("üîç Analyse de l'image en cours...", "loading");
            
            // Simulation plus r√©aliste avec d√©lai variable
            const processingTime = 1000 + Math.random() * 1000;
            
            setTimeout(() => {
                processImageWithEdgeDetection();
            }, processingTime);
        }
        
        function processImageWithEdgeDetection() {
            const context = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Redessiner l'image
                context.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Simulation de d√©tection de contours avec position al√©atoire r√©aliste
                const marginHorizontal = canvas.width * 0.1 + Math.random() * canvas.width * 0.1;
                const marginVertical = canvas.height * 0.1 + Math.random() * canvas.height * 0.1;
                
                const detectedRect = {
                    x: marginHorizontal,
                    y: marginVertical,
                    width: canvas.width - (marginHorizontal * 2),
                    height: canvas.height - (marginVertical * 2)
                };
                
                // Am√©lioration d'image
                enhanceImage(context, canvas.width, canvas.height);
                
                // Mettre √† jour l'image
                capturedImage = canvas.toDataURL('image/jpeg', 0.9);
                
                // Afficher le contour d√©tect√©
                showDetectedDocument(detectedRect);
                edgesDetected = true;
                
                processingOverlay.style.display = 'none';
                isProcessing = false;
                showStatus("‚úÖ Contours d√©tect√©s - Document optimis√©", "success");
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            };
            
            img.src = capturedImage;
        }
        
        function enhanceImage(context, width, height) {
            const imageData = context.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            // Am√©lioration du contraste
            for (let i = 0; i < data.length; i += 4) {
                // Augmenter le contraste
                const contrast = 1.4;
                data[i] = clamp((data[i] - 128) * contrast + 128);
                data[i + 1] = clamp((data[i + 1] - 128) * contrast + 128);
                data[i + 2] = clamp((data[i + 2] - 128) * contrast + 128);
                
                // L√©ger ajustement de la luminosit√©
                data[i] = clamp(data[i] * 1.1);
                data[i + 1] = clamp(data[i + 1] * 1.1);
                data[i + 2] = clamp(data[i + 2] * 1.1);
            }
            
            context.putImageData(imageData, 0, 0);
        }
        
        function showDetectedDocument(rect) {
            const containerRect = cameraContainer.getBoundingClientRect();
            const scaleX = containerRect.width / canvas.width;
            const scaleY = containerRect.height / canvas.height;
            
            documentOutline.style.left = (rect.x * scaleX) + 'px';
            documentOutline.style.top = (rect.y * scaleY) + 'px';
            documentOutline.style.width = (rect.width * scaleX) + 'px';
            documentOutline.style.height = (rect.height * scaleY) + 'px';
            
            edgePreview.style.display = 'block';
            
            // Animation d'apparition
            documentOutline.style.transform = 'scale(0.8)';
            documentOutline.style.opacity = '0';
            
            setTimeout(() => {
                documentOutline.style.transition = 'all 0.3s ease';
                documentOutline.style.transform = 'scale(1)';
                documentOutline.style.opacity = '1';
            }, 100);
        }
        
        function clamp(value) {
            return Math.max(0, Math.min(255, value));
        }
        
        // √âv√©nements boutons
        startCameraButton.addEventListener('click', startCamera);
        captureButton.addEventListener('click', captureImage);
        detectEdgesButton.addEventListener('click', detectEdges);
        
        // Sauvegarder en PDF
        savePdfButton.addEventListener('click', () => {
            if (!capturedImage) {
                showStatus("Aucune image √† sauvegarder", "error");
                return;
            }
            
            showStatus("üìÑ G√©n√©ration du PDF...", "loading");
            
            setTimeout(() => {
                generatePDF();
            }, 800);
        });
        
        // G√©n√©rer le PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const imgProps = pdf.getImageProperties(capturedImage);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(capturedImage, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const scanType = edgesDetected ? "scan-optimise" : "scan-standard";
            const filename = `document-${scanType}-${timestamp}.pdf`;
            
            pdf.save(filename);
            
            // Sauvegarder localement
            const scan = {
                id: Date.now(),
                image: capturedImage,
                filename: filename,
                date: new Date().toLocaleString('fr-FR'),
                enhanced: edgesDetected
            };
            
            scans.unshift(scan);
            localStorage.setItem('documentScans', JSON.stringify(scans));
            
            showStatus("‚úÖ PDF t√©l√©charg√© avec succ√®s!", "success");
            updateScansDisplay();
            
            // R√©initialiser
            savePdfButton.disabled = true;
            detectEdgesButton.disabled = true;
        }
        
        // Changer de cam√©ra
        switchCameraButton.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startCamera();
        });
        
        // Importer une image
        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showStatus("Veuillez s√©lectionner une image valide (JPEG, PNG)", "error");
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                capturedImage = e.target.result;
                showStatus("‚úÖ Image import√©e - Vous pouvez d√©tecter les contours", "success");
                detectEdgesButton.disabled = false;
                savePdfButton.disabled = false;
                edgesDetected = false;
                edgePreview.style.display = 'none';
                
                // Pr√©parer l'image pour le canvas
                const context = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);
                };
                img.src = capturedImage;
            };
            
            reader.readAsDataURL(file);
        });
        
        // Mettre √† jour l'affichage des scans
        function updateScansDisplay() {
            if (scans.length === 0) {
                scansContainer.innerHTML = '<div class="no-scans">Aucun document scann√© pour le moment</div>';
                return;
            }
            
            scansContainer.innerHTML = scans.map(scan => `
                <div class="scan-item">
                    <img src="${scan.image}" alt="Document scann√©" class="scan-preview">
                    <div class="quality-badge ${scan.enhanced ? 'enhanced' : ''}">
                        ${scan.enhanced ? '‚úì Optimis√©' : 'Standard'}
                    </div>
                    <div class="scan-actions">
                        <button class="action-btn download-btn" onclick="downloadScan(${scan.id})">
                            <span>‚¨áÔ∏è</span>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteScan(${scan.id})">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                    <div style="padding: 8px; font-size: 0.7rem; color: #666; text-align: center;">
                        ${scan.date.split(' ')[0]}
                    </div>
                </div>
            `).join('');
        }
        
        // T√©l√©charger un scan
        function downloadScan(id) {
            const scan = scans.find(s => s.id === id);
            if (!scan) return;
            
            const link = document.createElement('a');
            link.href = scan.image;
            link.download = scan.filename.replace('.pdf', '.jpg');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Supprimer un scan
        function deleteScan(id) {
            if (confirm("Supprimer ce document ?")) {
                scans = scans.filter(s => s.id !== id);
                localStorage.setItem('documentScans', JSON.stringify(scans));
                updateScansDisplay();
                showStatus("Document supprim√©", "success");
            }
        }
        
        // Afficher un message de statut
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'status';
                }, 4000);
            }
        }
        
        // R√©f√©rence au container
        const cameraContainer = document.querySelector('.camera-container');
        
        // Nettoyer
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
        
        // Emp√™cher les comportements ind√©sirables
        document.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'BUTTON') {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>